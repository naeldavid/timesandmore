<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prayer Times & Moon Phases</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        :root {
            --primary: #000;
            --secondary: #000;
            --accent: #000;
            --dark: #000;
            --darker: #000;
            --light: #fff;
            --card-bg: #fff;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background-color: #1a1a1a;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .header h1 {
            color: var(--light);
            margin: 0;
            font-size: 2.2rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .header::after {
            content: '';
            display: block;
            width: 100px;
            height: 3px;
            background: var(--light);
            margin: 15px auto 0;
            border-radius: 3px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            background: rgba(255,255,255,0.05);
            padding: 15px 20px;
            border-radius: 12px;
        }
        
        .location {
            font-size: 1.3rem;
        }
        
        .location span {
            display: block;
            font-size: 1rem;
            color: rgba(255,255,255,0.7);
            margin-top: 5px;
        }
        
        .moon-container {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
        }

        moon-phase {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            display: block;
            background: #1a1a1a;
        }

        moon-phase::before {
            content: '';
            position: absolute;
            inset: 0;
            background: url('/static/moon.png') center/cover;
            filter: brightness(1.2) contrast(1.1);
        }

        moon-phase::after {
            content: '';
            position: absolute;
            inset: 0;
            background: #000;
            border-radius: var(--_btlr, 0) var(--_btrr, 0) var(--_bbrr, 0) var(--_bblr, 0);
            filter: var(--moon-phase-mask-filter, blur(var(--moon-phase-blur, 0px)));
            height: 100%;
            inset-inline: var(--_ii, auto 0);
            opacity: var(--moon-phase-mask-opacity, .85);
            position: absolute;
            width: var(--_w);
        }

        /* Phases */
        [phase*="first quarter"],
        [phase*="waxing"] {
            --_ii: 0 auto;
        }

        [phase*="crescent"],
        [phase*="first quarter"],
        [phase*="waxing"] {
            --_bblr: 100%;
            --_btlr: 100%;
        }

        [phase*="crescent"],
        [phase*="last quarter"],
        [phase*="waning"] {
            --_btrr: 100%;
            --_bbrr: 100%;
        }

        [phase*="gibbous"]::after {
            border-radius: 0;
            width: 100%;
        }

        [phase="waxing gibbous"]::after {
            mask: radial-gradient(circle at 100% 50%,
                #0000 calc(100% - var(--_w)),
                #000 calc(100% - var(--_w) + 1px + (2 * var(--moon-phase-blur, 0))) 100%);
        }

        [phase="waning gibbous"]::after {
            mask: radial-gradient(circle at 0% 50%,
                #0000 calc(100% - var(--_w)),
                #000 calc(100% - var(--_w) + 1px + (2 * var(--moon-phase-blur, 0))) 100%);
        }
        
        .dates {
            display: flex;
            justify-content: space-between;
            background: rgba(255,255,255,0.05);
            padding: 15px 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .prayer-times {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .prayer {
            text-align: center;
            padding: 15px;
            background-color: #2d2d2d;
            color: #fff;
            border-radius: 10px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .prayer:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .prayer.next {
            background-color: #fff;
            color: #000;
            transform: scale(1.05);
            box-shadow: none;
            position: relative;
            z-index: 1;
        }
        
        .prayer.next::after {
            content: 'NEXT';
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--light);
            color: var(--dark);
            font-size: 0.7rem;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .prayer-name {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .time {
            font-size: 1.3rem;
            font-weight: 500;
            color: inherit;
        }
        
        .countdown-container {
            text-align: center;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .countdown-label {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        #next-prayer-name {
            color: var(--dark);
            font-weight: 600;
        }
        
        #countdown-timer {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark);
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }
        
        .qibla-container {
            text-align: center;
            padding: 10px;
        }
        
        .compass {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
            position: relative;
            margin: 0 auto 10px;
        }
        
        .qibla-arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 20px;
            background: linear-gradient(to bottom, #4CAF50 50%, #4CAF50 50%);
            transform-origin: center bottom;
            margin-left: -1px;
            margin-top: -20px;
        }

        .north-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 20px;
            background: linear-gradient(to bottom, #ff4444 50%, #ffffff 50%);
            transform-origin: center bottom;
            margin-left: -1px;
            margin-top: -20px;
        }
        
        .compass-label {
            position: absolute;
            font-size: 10px;
            color: rgba(255,255,255,0.7);
        }
        
        .compass-label.north {
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        @media (max-width: 768px) {
            .prayer-times {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .info-row, .dates {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .info-row {
                flex-direction: column;
                gap: 15px;
                align-items: center;
                text-align: center;
            }
            
            .location {
                width: 100%;
                text-align: center;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Prayer Times & Moon Phases</h1>
        </div>
        
        <div class="info-row">
            <div class="location">
                {{ city }}, {{ country }}
                <span>{{ timezone }}</span>
            </div>
            
            <div class="qibla-container">
                <div class="compass">
                    <div class="north-indicator"></div>
                    <div class="qibla-arrow" style="transform: rotate({{ qibla_direction }}deg)"></div>
                    <span class="compass-label north">N</span>
                </div>
                <small>Qibla Direction: {{ qibla_direction }}Â°</small>
            </div>
            
            <div class="moon-container">
                <moon-phase phase="{{ current_phase }}" illumination="{{ illumination }}"></moon-phase>
                <div class="moon-info">
                    <small>{{ current_phase }}<br>{{ illumination }}% illuminated</small>
                </div>
            </div>
        </div>
        
        <div class="dates">
            <div>Gregorian: {{ gregorian_date }}</div>
            <div>Hijri: {{ hijri_date }}</div>
        </div>
        
        <div class="prayer-times">
            <div class="prayer" id="fajr">
                <div class="prayer-name">Fajr</div>
                <div class="time">{{ prayer_times.Fajr }}</div>
            </div>
            <div class="prayer" id="dhuhr">
                <div class="prayer-name">Dhuhr</div>
                <div class="time">{{ prayer_times.Dhuhr }}</div>
            </div>
            <div class="prayer" id="asr">
                <div class="prayer-name">Asr</div>
                <div class="time">{{ prayer_times.Asr }}</div>
            </div>
            <div class="prayer" id="maghrib">
                <div class="prayer-name">Maghrib</div>
                <div class="time">{{ prayer_times.Maghrib }}</div>
            </div>
            <div class="prayer" id="isha">
                <div class="prayer-name">Isha</div>
                <div class="time">{{ prayer_times.Isha }}</div>
            </div>
        </div>
        
        <div class="countdown-container">
            <div class="countdown-label">
                Next Prayer: <span id="next-prayer-name"></span>
            </div>
            <div id="countdown-timer"></div>
        </div>
    </div>

    <script>
        function syncMoonAnimation(phase) {
            const phaseName = phase.toLowerCase();
            const moonImage = document.querySelector('.moon-phase-image');
            const animation = moonImage.style.animation;
            let animationDelay = 0;
            
            if (phaseName.includes('new')) {
                animationDelay = 0;
            } else if (phaseName.includes('waxing crescent')) {
                animationDelay = -0.3;
            } else if (phaseName.includes('first quarter')) {
                animationDelay = -3.7;
            } else if (phaseName.includes('waxing gibbous')) {
                animationDelay = -7.4;
            } else if (phaseName.includes('full')) {
                animationDelay = -11.1;
            } else if (phaseName.includes('waning gibbous')) {
                animationDelay = -14.8;
            } else if (phaseName.includes('last quarter')) {
                animationDelay = -18.5;
            } else if (phaseName.includes('waning crescent')) {
                animationDelay = -22.2;
            }
            
            moonImage.style.animation = `moonCycle 29.5s linear infinite ${animationDelay}s`;
        }

        function updateNextPrayer() {
            const now = new Date();
            const prayerElements = {
                'Fajr': document.getElementById('fajr'),
                'Dhuhr': document.getElementById('dhuhr'),
                'Asr': document.getElementById('asr'),
                'Maghrib': document.getElementById('maghrib'),
                'Isha': document.getElementById('isha')
            };
            
            Object.values(prayerElements).forEach(el => el.classList.remove('next'));
            
            let nextPrayer = null;
            let minDiff = Infinity;
            
            for (const [name, element] of Object.entries(prayerElements)) {
                const timeText = element.querySelector('.time').textContent;
                const [hours, minutes] = timeText.split(':').map(Number);
                const prayerTime = new Date();
                prayerTime.setHours(hours, minutes, 0, 0);
                
                if (prayerTime < now) prayerTime.setDate(prayerTime.getDate() + 1);
                
                const diff = prayerTime - now;
                if (diff > 0 && diff < minDiff) {
                    minDiff = diff;
                    nextPrayer = name;
                }
            }
            
            if (nextPrayer) {
                prayerElements[nextPrayer].classList.add('next');
                document.getElementById('next-prayer-name').textContent = nextPrayer;
                
                const hours = Math.floor(minDiff / (1000 * 60 * 60));
                const minutes = Math.floor((minDiff % (1000 * 60 * 60)) / (1000 * 60));
                
                document.getElementById('countdown-timer').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const moonPhase = document.querySelector('moon-phase');
            if (moonPhase) {
                const illumination = parseInt(moonPhase.getAttribute('illumination')) || 0;
                const phase = moonPhase.getAttribute('phase').toLowerCase();
                
                let clipPath;
                
                if (phase.includes('waxing')) {
                    // For waxing phases, the shadow moves from left to right
                    const radius = 50;
                    const angle = Math.PI * (illumination / 100);
                    const x = radius + radius * Math.cos(angle);
                    const curve = `M 50 0 A 50 50 0 0 1 50 100 L ${x} 100 L ${x} 0 Z`;
                    clipPath = `path('${curve}')`;
                } else if (phase.includes('waning')) {
                    // For waning phases, the shadow moves from right to left
                    const radius = 50;
                    const angle = Math.PI * (1 - illumination / 100);
                    const x = radius + radius * Math.cos(angle);
                    const curve = `M 50 0 A 50 50 0 0 0 50 100 L ${x} 100 L ${x} 0 Z`;
                    clipPath = `path('${curve}')`;
                } else if (phase.includes('full')) {
                    clipPath = 'none';
                } else {
                    // New moon
                    clipPath = 'circle(50%)';
                }
                
                moonPhase.style.setProperty('--clip-path', clipPath);
            }
        });

        function isAdvancedAttrSupported() {
            const T = document.createElement('div');
            document.body.appendChild(T);
            
            try {
                T.style.setProperty('--t', 'attr(data-test type(<number>), 0)');
                T.dataset.test = "123";
                const computedValue = getComputedStyle(T).getPropertyValue('--t').trim();
                return computedValue === "123";
            } catch (e) {
                return false;
            } finally {
                T.remove();
            }
        }

        if (!isAdvancedAttrSupported()) {
            const moons = document.querySelectorAll('moon-phase');
            moons.forEach(moon => {
                const lat = moon.getAttribute('lat');
                const hour = moon.getAttribute('hour');
                moon.style.setProperty('--_w', `${100 - moon.getAttribute('illumination')}%`);
                if (lat) moon.style.setProperty('--_lat', lat);
                if (hour) moon.style.setProperty('--_hour', hour);
            });
        }
    </script>

    <script>
        let notificationPermission = false;

        async function requestNotificationPermission() {
            if (!("Notification" in window)) {
                alert("This browser does not support notifications");
                return;
            }

            const permission = await Notification.requestPermission();
            notificationPermission = permission === "granted";
        }

        function sendPrayerNotification(prayerName) {
            if (notificationPermission) {
                new Notification("Prayer Time", {
                    body: `It's time for ${prayerName} prayer`,
                    icon: "/static/favicon.ico"
                });
            }
        }

        function checkPrayerTime() {
            const now = new Date();
            const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            const prayers = {
                'Fajr': document.querySelector('#fajr .time').textContent,
                'Dhuhr': document.querySelector('#dhuhr .time').textContent,
                'Asr': document.querySelector('#asr .time').textContent,
                'Maghrib': document.querySelector('#maghrib .time').textContent,
                'Isha': document.querySelector('#isha .time').textContent
            };

            for (const [name, time] of Object.entries(prayers)) {
                if (currentTime === time) {
                    sendPrayerNotification(name);
                }
            }
        }

        // Update the DOMContentLoaded event listener:
        document.addEventListener('DOMContentLoaded', async function() {
            await requestNotificationPermission();
            updateNextPrayer();
            setInterval(updateNextPrayer, 60000); // Changed to check every minute instead of every second
            setInterval(checkPrayerTime, 60000); // Check for prayer times every minute
        });
    </script>
</body>
</html>